!! This module handles reading the namelist and provides access to some other flags
!! that control a specific CARMA model's behavior.
!!
!! By default the specific CARMA model does not have any unique namelist values. If
!! a CARMA model wishes to have its own namelist, then this file needs to be copied
!! from physics/cam to physics/model/<model_name> and the code needed to read in the
!! namelist values added there. This file will take the place of the one in
!! physics/cam. 
!!
!! It needs to be in its own file to resolve some circular dependencies.
!!
!! @author  Chuck Bardeen
!! @version Mar-2011
module carma_model_flags_mod

  use shr_kind_mod,   only: r8 => shr_kind_r8
  use spmd_utils,     only: masterproc

  ! Flags for integration with CAM Microphysics
  public carma_model_readnl                   ! read the carma model namelist
  

  ! Namelist flags
  !
  ! Create a public definition of any new namelist variables that you wish to have,
  ! and default them to an inital value.

  ! name of the dust erosion factor file
  logical, public            :: carma_do_WeibullK   = .false.  ! if .true. then use calculated Weibull K, [Monahan, 2006]
  character(len=32), public  :: carma_seasalt_emis  = 'Gong'   ! the source function scheme, either "Gong", "Martensson",
                                                               ! "Clarke",  "Caffrey", "CMS", "CONST", or "NONE" 
  character(len=256), public     ::  carma_soilerosion_file  = 'soil_erosion_factor_1x1_c120907.nc'
  !character(len=256), public :: BC_GAINS_filename   = '/glade/work/pengfeiy/data/ETP_base_CLE_V5_BC_2010.nc'   ! name of the new BC emission file
  !character(len=256), public :: OC_GAINS_filename   = '/glade/work/pengfeiy/data/ETP_base_CLE_V5_OC_2010.nc'
  character(len=256), public :: BC_GAINS_filename   = '/glade/work/pengfeiy/data/CP_WEO11_S10P50_BC_2010.nc'   ! name of the new BC emission file
  character(len=256), public :: OC_GAINS_filename   = '/glade/work/pengfeiy/data/CP_WEO11_S10P50_OC_2010.nc'
  !character(len=256), public :: BC_ship_filename    = '/glade/work/pengfeiy/data/IPCC_emissions_RCP60_BC_ships_2005_0.5x0.5_v1_01_03_2010.nc'
  !character(len=256), public :: OC_ship_filename    = '/glade/work/pengfeiy/data/IPCC_emissions_RCP60_OC_ships_2005_0.5x0.5_v1_01_03_2010.nc'
  character(len=256), public :: BC_ship_filename    = '/glade/work/pengfeiy/data/IPCC_BC_ships_2010_0.5x0.5.nc'
  character(len=256), public :: OC_ship_filename    = '/glade/work/pengfeiy/data/IPCC_OC_ships_2010_0.5x0.5.nc'
  character(len=256), public :: BC_GFEDv3_filename  = '/glade/work/pengfeiy/data/GFEDv3_BC_2010.nc'
  character(len=256), public :: OC_GFEDv3_filename  = '/glade/work/pengfeiy/data/GFEDv3_OC_2010.nc'

contains


  !! Read the CARMA model runtime options from the namelist
  !!
  !! @author  Chuck Bardeen
  !! @version Mar-2011
  subroutine carma_model_readnl(nlfile)
  
    ! Read carma namelist group.
  
    use cam_abortutils,  only: endrun
    use namelist_utils,  only: find_group_name
    use units,           only: getunit, freeunit
    use mpishorthand
  
    ! args
  
    character(len=*), intent(in) :: nlfile  ! filepath for file containing namelist input
  
    ! local vars
  
    integer :: unitn, ierr
  
    ! read namelist for CARMA
    namelist /carma_model_nl/ &
      carma_do_WeibullK, &
      carma_seasalt_emis, &
      carma_soilerosion_file, &
      BC_GAINS_filename, &
      OC_GAINS_filename, &
      BC_ship_filename, &
      OC_ship_filename, &
      BC_GFEDv3_filename, &
      OC_GFEDv3_filename 
  
    if (masterproc) then
       unitn = getunit()
       open( unitn, file=trim(nlfile), status='old' )
       call find_group_name(unitn, 'carma_model_nl', status=ierr)
       if (ierr == 0) then
          read(unitn, carma_model_nl, iostat=ierr)
          if (ierr /= 0) then
             call endrun('carma_model_readnl: ERROR reading namelist')
          end if
       end if
       close(unitn)
       call freeunit(unitn)
    end if
  
#ifdef SPMD
    call mpibcast(carma_soilerosion_file,      len(carma_soilerosion_file),       mpichar, 0, mpicom)
    call mpibcast(carma_do_WeibullK,   1,                       mpilog,  0, mpicom)
    call mpibcast(carma_seasalt_emis, len(carma_seasalt_emis), mpichar, 0, mpicom)
    call mpibcast(BC_GAINS_filename,  len(BC_GAINS_filename), mpichar, 0, mpicom)
    call mpibcast(OC_GAINS_filename,  len(OC_GAINS_filename), mpichar, 0, mpicom)
    call mpibcast(BC_ship_filename,   len(BC_ship_filename), mpichar, 0, mpicom)
    call mpibcast(OC_ship_filename,   len(OC_ship_filename), mpichar, 0, mpicom)
    call mpibcast(BC_GFEDv3_filename, len(BC_GFEDv3_filename), mpichar, 0, mpicom)
    call mpibcast(OC_GFEDv3_filename, len(OC_GFEDv3_filename), mpichar, 0, mpicom)
#endif
  
  end subroutine carma_model_readnl

end module carma_model_flags_mod
